# 国家運営シミュレーションゲーム

## ゲームロジック詳細設計書

---

## 1. 用語定義

本章では、本ゲームに登場する主要概念を**ゲーム内での意味**として定義する。データ構造や詳細仕様は後述章に記載する。

### 1.1 国家（Nation）

* プレイヤーおよびNPCが操作する運営主体
* 国力、ユニット、ステートなどを保持する

### 1.2 国力（Power）

* 国家のリソース量を現す基礎数値
* 内政・戦闘・ステート効果によって増減する
* 数値上限：**1,000,000,000（10億）**

### 1.3 ユニット（Unit）

* 国家に所属する戦力単位
* 戦闘時に前線・中衛・後衛・ベンチのいずれかに配置される
* 各ユニットは個別のステータスとスキル・ステートを持つ

### 1.4 ステート（State）

* 国家またはユニットに付与される持続効果
* 内政・戦闘・内政回数・数値計算などに影響を与える

### 1.5 スキル（Skill）

* ユニットが戦闘時に使う攻撃行動の詳細
* 攻撃対象、攻撃倍率、追加効果などが設定されている

### 1.6 コマンド（Command）

* プレイヤーが内政フェーズで選択的に実行する行動
* 国力消費を伴う場合が多い

### 1.7 ステージ（Stage）

* 初期状態やゲーム設定を決める情報

---

## 2. データ構造定義

### 2.1 ステージデータ

* ステージID
* 各国家の初期状態のデータの配列
* 内政回数
* 決着ラウンド数
* 決着国力

### 2.2 国家データ

* 手番（国家ID）
* 国名
* プレイヤー操作かNPCか
* 残り内政回数
* 国力
* ステート配列（付与順を保持）
* ユニット配列（ポジションを保持）
* 内政コマンド配列
* 行動コマンド配列
* 目標軍事力比率
* 好戦度
* 敵対国IDの配列

### 2.3 ユニットデータ

* ユニットID
* 所属国家ID
* ユニット名
* 最大HP
* 現在HP
* 攻撃力
* スキル配列
* ステート配列（付与順を保持）

### 2.4 ステートデータ

* ステートID
* ステート名
* スタック可否フラグ
* 残りターン数
* パッシブ効果フラグ
* 発動タイミング
* 発動回数
* 効果内容の配列（適用順を保持）
* 上位排他ステートの配列
* 同位排他ステートの配列
* 下位排他ステートの配列
```
State {
stateId: number, // ステートID
name: string, // ステート名

unitId: number, // 所持ユニットID
ownerNationId: number, // 所属国家ID

stacks: number | null, // スタック数（null = スタック不可）
duration: number | null, // 残りターン数（null = 永続）
triggerTimings: TriggerTiming[], // 発動タイミング配列
remainings: number, //残り発動回数

effects: Effect[], // 効果配列（配列順に処理）

excludes: number[][] // 排他ステートの配列(1行目は上位排他、2行目は同位排他、3行目は下位排他)
}
```

### 2.5 スキルデータ

```Skill {
skillId: number, // スキルID
name: string, // スキル名

priority: number, // 発動優先度（高いほど先）
targetPattern: TargetPattern, // 攻撃対象指定

preEffects: Effect[], // 攻撃前効果
damageRate: number, // ユニットダメージ倍率
powerStealRate: number, // 国力奪取倍率
unitEffects: Effect[], // ユニット追加効果
nationEffects: Effect[] // 国家追加効果
}
```

### 2.6 コマンドデータ

```
Command {
commandId: number, // コマンドID
name: string, // コマンド名

effects: Effect[] // 効果配列（順番に処理）
}
```

### 2.7 ゲーム管理データ

```
GameState {
stageId: number, // 現在のステージID
commandNum: number, // 内政回数

currentRound: number, // 現在ラウンド数
roundLimit: number, // 決着ラウンド数


nations: Nation[], // 全国家データ配列（手番順）
currentTurnIndex: number // 現在手番インデックス

processQueue: State[], // ステート処理キュー
}
```

### 2.8 戦闘管理データ

```
BattleContext {
attackerNationId: number, // 攻撃側国家ID
defenderNationId: number, // 防御側国家ID


attackOrder: Unit[], // 攻撃順序配列
currentAttackIndex: number,// 現在処理中の攻撃インデックス


currentAttacker?: Unit, // 攻撃中ユニット
targetUnits: (Unit | null)[], // 被攻撃ユニット配列（null含む）
targetIndex: number,// 現在処理中の被攻撃ユニットインデックス


pendingPowerDamage: number // 暫定国力奪取量
}
```

---

## 3. ゲーム進行構造

### 3.1 ゲーム進行の流れ

* 全国家が1回ずつ行動する単位を1ラウンドとする
* ラウンド内での行動順は国家データが持つ手番の値の昇順で固定

1. ゲーム開始フェーズ
2. ラウンド処理を規定ラウンド分繰り返し
3. ゲーム終了フェーズ

#### 3.1.1 ゲーム開始フェーズ

* ステージデータを読み込み
* ゲーム管理データの現在ターン数を0で初期化する
* ゲーム管理データのステージID、決着ラウンド数、決着国力をステージデータに設定された値で初期化する
* プレイヤーおよびNPCの国家情報をステージデータに設定された値で初期化する

#### 3.1.2 ラウンド処理

* 3.2で定義するラウンド処理を決着ラウンドまで繰り返す

#### 3.1.3 ゲーム終了フェーズ

* 各国家の国力を比較し、最大値の国家が複数存在する場合、手番の小さい国家の国力を+1する処理を
  最大値の国家が1つになるまで繰り返す
* 国力最大値の国家を勝者とする

### 3.2 ラウンドの流れ

1. ラウンド開始フェーズ
2. 各国家のターン処理
3. ラウンド終了フェーズ

#### 3.2.1 ラウンド開始フェーズ

1. ゲーム管理データの現在ターン数をインクリメントする
2. ゲーム管理データの現在手番を0にする
3. ゲーム管理データの内政回数を各国家の残り内政回数に代入する
4. 優先順位に基づき、各国家・ユニットのステート処理を実行する

#### 3.2.2 各国家のターン処理

1. ゲーム管理データの現在手番をインクリメントする
2. 現在手番の国家に滅亡ステートが付与されている場合は処理終了して次の国家のターン処理へ飛ぶ
3. そうでない場合、現在手番の国家のターン処理を実行する

ターン処理の詳細は3.3で定義

#### 3.2.3 ラウンド終了フェーズ

1. 国力が0の国家に対して滅亡ステートを付与する
2. 優先順位に基づき、各国家・ユニットのステート処理を実行する
3. 滅亡ステートが付与されていない国家が一つしか残っていない場合、ゲーム終了フェーズへ飛ぶ
4. そうでない場合はラウンド開始フェーズへ飛ぶ

### 3.3 ターンの流れ

1. ターン開始フェーズ
2. 内政フェーズ
3. 行動判断フェーズ ※NPC国家のみ
4. 戦闘フェーズまたは行動フェーズ
5. ターン終了フェーズ

#### 3.3.1 ターン開始フェーズ

1. 優先順位に基づき、各国家・ユニットのステート処理を実行する

#### 3.3.2 内政フェーズ

UI・設定上はプレイヤー操作・NPC自動処理で扱いは変わらないが、内部的には以下のように処理を分ける

##### プレイヤー国家の場合

1. プレイヤーのコマンド選択を待つ
2. 内政コマンドの場合
   1. コマンドの効果内容配列の先頭から全ての処理を実行する
   2. 優先順位に基づき、各国家・ユニットのステート処理を実行する
   3. コマンド選択へ戻る
3. 戦闘コマンドの場合、戦闘フェーズへ飛ぶ
4. 戦闘以外の行動コマンドの場合、行動フェーズへ飛ぶ

##### NPC国家の場合

1. 選択可能な内政コマンドが存在する場合、選択可能な内政コマンド全てについて以下を実行する
   1. ゲーム管理データのディープコピーを作成し、プレビュー情報とする
   2. プレビュー上でコマンドの効果内容配列の先頭から全ての処理を実行する
   3. プレビュー上で優先順位に基づき、各国家・ユニットのステート処理を実行する
   4. プレビュー上のコマンド実行後の自国家の"コマンド優先度スコア"を保持する
2. "コマンド優先度スコア"が最も高い内政コマンドを選択する
3. 選択されたコマンドの効果内容配列の先頭から全ての処理を実行する
4. 優先順位に基づき、各国家・ユニットのステート処理を実行する
5. 1.へ戻る
6. 選択可能なコマンドが存在しない場合、行動判断フェーズへ飛ぶ

なお、"コマンド優先度スコア"は以下のルールで算出する
```自国家の国力 * 目標軍事力比率 + 前線に出ているユニットのHPと攻撃力の合計```


#### 3.3.3 行動判断フェーズ

以下において、"軍事力"とは以下を指す
```(前線に出ているユニットのHPと攻撃力の合計) * その国家のステートによる補正値```

1. 敵対国IDの配列に含まれている国家の中で、最も軍事力が近い国家を候補国として選ぶ
2. 自国の軍事力 * 好戦度　> 候補国の軍事力の場合、候補国を戦闘対象国として決定し、戦闘フェーズへ飛ぶ
3. そうでない場合、選択可能な行動コマンド全てについて以下を実行する
   1. ゲーム管理データのディープコピーを作成し、プレビュー情報とする
   2. プレビュー上でコマンドの効果内容配列の先頭から全ての処理を実行する
   3. プレビュー上のコマンド実行後の自国家の"コマンド優先度スコア"を保持する
4. "コマンド優先度スコア"が最も高い内政コマンドを選択する

#### 3.3.4 行動フェーズ

1. 選択されたコマンドの効果内容配列の先頭から全ての処理を実行する
2. 優先順位に基づき、各国家・ユニットのステート処理を実行する

#### 3.3.5 戦闘フェーズ

##### 3.3.5.1 戦闘フェーズの流れ

1. 戦闘開始ステップ
2. 各ユニットの攻撃処理
3. 戦闘終了ステップ

##### 3.3.5.2 戦闘開始ステップ

1. 戦闘管理データの攻撃インデックスを0にする
2. 戦闘管理データの攻撃側国家IDと防御側国家IDを設定する
3. 戦闘管理データの暫定国力奪取量を0に設定する
4. 優先順位に基づき、各国家・ユニットのステート処理を実行する
5. 攻撃順序を決定し、戦闘管理データの攻撃順序配列に代入する

* 攻撃順序は
  **スキルの優先度**→**ポジション**→**所属国家**の順で決定する
  * スキル優先度が高いほど先に攻撃できる
  * ポジションが後ろになる程先に攻撃できる
  * 攻撃側国家のユニットが先に攻撃できる

##### 3.3.5.3 各ユニットの攻撃処理の流れ

1. 攻撃開始ステップ
2. 攻撃対象決定ステップ
3. 攻撃直前ステップ
4. 攻撃順序配列に格納された攻撃対象ユニットごとに以下を実施
   1. ユニットダメージステップ
5. 国力ダメージステップ
6. 攻撃直後ステップ
7. 攻撃終了ステップ

###### 3.3.5.3.1 攻撃開始ステップ

1. `攻撃順序配列[処理済みスキル数]`に格納された攻撃者を取得
2. 攻撃者に死亡ステートが付与されている場合、そのユニットを攻撃順序配列からpopし1.に戻る
3. そうでない場合、そのユニットを攻撃中ユニットに設定
4. 戦闘管理データの被攻撃ユニットインデックスを0にする
5. 戦闘管理データの暫定国力ダメージを0にする
6. 優先順位に基づき、各国家・ユニットのステート処理を実行する

###### 3.3.5.3.2 攻撃対象決定ステップ

以下の処理において、「ポジションが空」とはそのポジションにユニットが配置されていない、または配置されていたユニットが死亡している状態のことを指す

1. 被攻撃ユニット配列に、攻撃者のスキルの攻撃範囲と同じ長さでnull埋めされた配列を代入
2. 相手前線にユニットが存在しない場合はステップ終了し攻撃直前ステップに飛ぶ
3. そうでない場合、以下を実行
   1. スキルで指定された正規の攻撃対象を確認し、その範囲にユニットが一人でも存在する場合はその範囲で決定
   2. 1.の範囲が空の場合は、正規対象よりも1つ後ろを確認し、ユニットが存在すればその範囲で決定
   3. 2.の範囲が空の場合は、正規対象よりも2つ後ろを確認し、ユニットが存在すればその範囲で決定
   4. 3.の範囲が空の場合は、正規対象よりも1つ手前を確認し、ユニットが存在すればその範囲で決定
   5. 4.の範囲が空の場合は、正規対象よりも2つ手前を確認し、ユニットが存在すればその範囲で決定
   6. 被攻撃ユニット配列に`[決定した範囲に存在するユニット, 決定した範囲の空きポジションの数だけnull]`を代入
   
###### 3.3.5.3.3 攻撃直前ステップ

1. スキルに攻撃前効果が設定されている場合はその処理を実行する
2. 優先順位に基づき、各国家・ユニットのステート処理を実行する
   
###### 3.3.5.3.4 ユニットダメージステップ

1. `被攻撃ユニット配列[被攻撃ユニットインデックス]`を処理対象として取得
2. 処理対象がnullの場合、国力ダメージステップへ飛ぶ
3. 処理対象がユニットの場合、処理対象へのダメージを以下で計算する
    ```ユニットの攻撃力 × スキルの攻撃倍率```
4. 計算されたダメージを処理対象の現在HPから減算する
5. スキルにユニット追加効果が設定されている場合はその処理を行う
6. 被攻撃ユニットインデックスをインクリメント
7. 被攻撃ユニット配列の長さ=被攻撃ユニットインデックスの場合、国力ダメージステップへ飛ぶ
8. それ以外の場合は1.へ戻る
   
###### 3.3.5.3.5 国力ダメージステップ

1. 攻撃者が防御側国家に属している場合、攻撃直後ステップまでスキップ
2. それ以外の場合、被攻撃ユニット配列の要素ごとに以下を実行
   1. そのポジションについての国力ダメージを以下で計算する
      ```ユニットの攻撃力 × スキルの国力ダメージ率 × ユニットダメージ処理後の対象HP損失率```
      「対象HP損失率」とは、(対象の最大HP - 対象の現在HP) / 対象の最大HP のことである
      ポジションが空の場合は対象HP損失率は1として扱う
   2. 計算されたダメージを暫定国力奪取量に加算する
3. スキルに国家追加効果が設定されている場合はその処理を行う

###### 3.3.5.3.6 攻撃直後ステップ

1. スキルに攻撃後効果が設定されている場合はその処理を実行する
2. 優先順位に基づき、各国家・ユニットのステート処理を実行する

###### 3.3.5.3.7 攻撃終了ステップ

1. 戦闘参加ユニットに現在HPが0のものが存在している場合、そのユニットに死亡ステートを付与する
2. 優先順位に基づき、各国家・ユニットのステート処理を実行する

##### 3.3.5.4 戦闘終了ステップ

1. 防御側国家の国力から暫定国力奪取量に格納された値を減算する。国力<暫定国力奪取量の場合は国力と同じ値を減算し0にする。実際に減算したのと同じ額を攻撃側国家の国力に加算する。
2. 優先順位に基づき、各国家・ユニットのステート処理を実行する

#### 3.3.6 ターン終了フェーズ

1.  優先順位に基づき、各国家・ユニットのステート処理を実行する

## 4. 共通処理

### 4.1 数値ルール

四則演算について下記のルールに従うラッパー関数を用意し、ゲーム中の四則演算は必ずそれを使うようにする

#### 4.1.1 数値の丸め規則

* 小数が発生した場合は **常に切り上げ（ceil）** を行う

#### 4.1.2 数値上限・下限

* 国力・HP・攻撃力などの主要数値

  * 最小値：0
  * 最大値：1,000,000,000
* 上限を超える加算が発生した場合は上限で丸める

###　4.2 優先順位

* 複数の効果が同時に発動する場合の優先順位は常に
  **国家の優先順位**→**同一国家内での優先順位**→**発動者内での優先順位**の順で決定する
* 優先付け処理開始時点のステート状況をもとに発動順序を確定させ、効果処理中に新たなステート付与があっても再計算しない

#### 4.2.1 国家の優先順位
1. 現在のターンプレイヤー
2. 次のターンプレイヤー
3. 以下同様に順送り

#### 4.2.2 同一国家内での優先順位
1. 国家ステート
2. 国家のユニット配列の昇順

#### 4.2.3 発動者内での優先順位
1. ステート配列の先頭から順に確認

### 4.3 ステート付与処理
以下の処理フローに従ってステート付与を行うラッパー関数を用意し、ゲーム中はそれを使う。
「特定ステートを付与」の効果で下記処理が呼びだされ、処理の結果そのステートが付与されなくても問題ない。

1. ステートのマスターデータから付与予定のステートIDでステート情報を取得
2. 付与対象ユニットが付与予定のステートをすでに持っていない場合、以下のステート付与可否判定に移る
   1. 取得したステート情報の排他ステート配列の1行目（上位排他）に記載のステートを付与対象ユニットがすでに持っている場合、ステート付与せず処理中断
   2. 取得したステート情報の排他ステート配列の2行目（同位排他）に記載のステートを付与対象ユニットがすでに持っている場合、付与されている同位排他ステートすべてについて、スタック数が1またはスタック不可ステートの場合、そのステートを削除する。それ以外の場合スタック数を1減らす。付与予定だったステートは付与せずに処理中断
   3. 取得したステート情報の排他ステート配列の3行目（下位排他）に記載のステートを付与対象ユニットがすでに持っている場合、付与されている下位排他ステートを全て削除する（処理続行）
   4. 排他ステートが無いまたは下位排他ステートしかなかった場合、1.で取得した付与予定ステート情報のディープコピーを用意する
   5. ディープコピーのユニットIDと所属国家IDに付与対象ユニットのユニットIDと所属国家IDを代入し、ユニットのステート配列にpushし処理終了
3. 付与対象ユニットが付与予定のステートをすでに持っている場合は以下のステート更新処理を行う
   1. ステートのスタック数がnullでない場合、スタック数をインクリメント
   2. ステートの残りターン数がnullでない場合、残りターン数にマスタデータの値を代入
   3. ステートの残り発動回数がnullでない場合、残り発動回数にマスタデータの値を代入

### 4.4 ステート効果処理

各フェーズごとにある"優先順位に基づき、各国家・ユニットのステート処理を実行する”という処理は、具体的には以下の処理である。

1. 優先順位ルールに基づきこの時点のゲームデータをもとにステート処理キューを作成する
2. 以下ループ
   1. ステート処理キューの先頭要素をpop

## 5. 実装に関する特記事項

ステートなどの個別効果で例えば「墓地に送る」効果を「消滅させる」効果にすり替えたりができるように、すべての効果処理はラッパー関数を通して実行するようにし、そのラッパー関数内で効果のすり替え処理をできる形にする。